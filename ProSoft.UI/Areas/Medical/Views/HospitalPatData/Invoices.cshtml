@using ProSoft.UI.Global
@model List<PatViewDTO>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers


@{
    ViewData["Title"] = "Invoices";
    Layout = "~/Views/Shared/_Layout.cshtml";
    SelectList mainList = new SelectList(ViewBag.MainClinics, "ClinicId", "ClinicDesc");

}
@inject IViewLocalizer localizer

<style>
    .active-row {
        background-color: #cdcdcd;
    }

    .image {
        top: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-size: cover;
        background-position: center;
        opacity: 0.5;
        z-index: -1;
    }
</style>
<div class="text-center">
    <h1 class="mb-2">@localizer["Hospital Patient Data For Invoices"]</h1>
</div>

<div class="container pt-2" style="min-height:100vh;">


    <div class="d-flex align-items-md-center flex-column flex-md-row justify-content-between mb-2 gap-2">
        <div>
            <h4 class="ms-2 my-1">@localizer["Search for patient.."]</h4>
        </div>
        <div class="w-50 ">
            <input type="text" class="form-control" id="searchInput" placeholder="@localizer["Search by ID, Name, or Mobile..."]">
        </div>
        <div>
            <a asp-controller="Patient" asp-action="Add_Patient" asp-route-redirect="Invoices" asp-route-controll="HospitalPatData" class="btn btn-sm btn-primary fs-6">
                @Html.Raw(GlobalConstants.InsertIcon) @localizer["Add New Patient"]
            </a>

        </div>
    </div>
    <div class="border border-success p-0 mb-2 border-opacity-75 overflow-auto" style="height: 150px;">
        <table id="myTable" class="table table-bordered table-hover" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th>
                        @localizer["Patient ID"]
                    </th>
                    <th>
                        @localizer["Patient Name"]
                    </th>
                    <th>
                        @localizer["Patient Mobile"]
                    </th>
                    @*   <th>
                        Record
                        </th> *@

                </tr>
            </thead>
            <tbody>
                @foreach (var pat in Model)
                {
                    <tr onclick="GetAdmisson(event,@pat.PatId)" style="cursor:pointer;">

                        <td>
                            @pat.PatId
                        </td>

                        <td class="item-name">
                            @pat.PatName
                        </td>
                        <td>
                            @pat.PatMobile
                        </td>

                        @*                          <td class="text-center">
                        *@                                @* asp-area="Medical" asp-controller="PatRecord" asp-action="Index" asp-route-ID="@pat.PatId" *@
                        @*  <a onclick="setToStorage(event, @pat.PatId)" class="btn btn-sm btn-success" style="width:150px">
                            GO TO RECORD
                            </a> *@
                        @*  </td> *@

                    </tr>

                }
            </tbody>
        </table>
    </div>
    @* /////////////////////////////////////////////////////////////////// *@

    @* Table for PatAdmissions *@

    <div class="admission-table-head d-flex justify-content-between align-items-center mt-4">
        <h2 class="header pat-admission">@localizer["Visits of patient :"]</h2>

        <a class="btn btn-sm btn-primary fs-6">
            @Html.Raw(GlobalConstants.InsertIcon) @localizer["Add Visit"]
        </a>
        @* asp-controller="MedAnalysis" asp-action="Add_SubItemAnalysis" asp-route-ID="@ViewBag.item.MainCode" asp-route-itemAnalCode="" *@
    </div>

    <div class="border border-success p-0 mb-2 border-opacity-75 overflow-auto" style="max-height: 150px;">

        <table id="myTable" class="table table-bordered table-hover admisson-table" style="width:100%">
            <thead class="table-dark">
                <tr>
                    <th class="align-middle">
                        @localizer["Master Id"]
                    </th>
                    <th class="align-middle">
                        @localizer["Entry Date"]
                    </th>
                    <th class="align-middle" width="2px">
                        @localizer["Entity Code"]
                    </th>
                    <th class="align-middle">
                        @localizer["Entity Name"]
                    </th>
                    <th class="align-middle">
                        @localizer["subEntity Name"]
                    </th>
                    <th class="align-middle">
                        @localizer["Department"]
                    </th>
                    @* <th class="align-middle">
                            @localizer["Sent From"]
                        </th> *@
                    <th class="align-middle">
                        @localizer["Doctor Name"]
                    </th>
                    <th class="align-middle">
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
    @* /////////////////////////////////////////////////////////////////// *@

    @* Table for ClinicTrans *@

    <div class="clinicTrans-table-head d-flex justify-content-between align-items-center mt-4">
        <h2 class="header clinic-trans">@localizer["Clinic Transaction Invoices For Visit No."] </h2>

        <div>

            <a class="btn btn-sm btn-primary fs-6">
                @Html.Raw(GlobalConstants.InsertIcon) @localizer["Add Transaction"]
            </a>
            <a class="btn btn-sm btn-primary fs-6" id="btnAddNew">
                @Html.Raw(GlobalConstants.InsertIcon) @localizer["Add New Row"]
            </a>
            <a class="btn btn-sm btn-primary fs-6" id="btnAddNew">
                @Html.Raw(GlobalConstants.SaveIcon) @localizer["Save"]
            </a>
        </div>
        @* asp-controller="MedAnalysis" asp-action="Add_SubItemAnalysis" asp-route-ID="@ViewBag.item.MainCode" asp-route-itemAnalCode="" *@
    </div>

    <div class="p-0 mb-2 border-opacity-75 overflow-auto">

        <table id="myTable" class="table table-bordered table-hover clinicTrans-table" style="width:100%">
            <thead class="table-dark">
                <tr>

                    <th class="align-middle">
                        @localizer["Invoice Date"]
                    </th>
                    <th class="align-middle">
                        @localizer["Servise OR Item"]
                    </th>
                    <th class="align-middle">
                        @localizer["Main Clinic"]
                    </th>
                    <th class="align-middle">
                        @localizer["Sub Clinic"]
                    </th>
                  
                    <th class="align-middle">
                        @localizer["Clinic Service"]
                    </th>
                    <th class="align-middle">
                        @localizer["Sender Doctor"]
                    </th>
                    <th class="align-middle">
                        @localizer["Quantity"]
                    </th>
                    <th class="align-middle">
                        @localizer["Service Price"]
                    </th>
                    <th class="align-middle">
                        @localizer["All Service Price"]
                    </th>
                    <th class="align-middle">
                        @localizer["Stock"]
                    </th>
                    <th class="align-middle">
                        @localizer["Patient Value"]
                    </th>
                    <th class="align-middle">
                        @localizer["Company Value"]
                    </th>
                    <th class="align-middle">
                        @localizer["Discount"]
                    </th>
                    <th class="align-middle">
                        @localizer["Patient Requirements"]
                    </th>
                    <th class="align-middle">
                        @localizer["Patient Maintainance"]
                    </th>
                    <th class="align-middle">
                        @localizer["Attendance Shift"]
                    </th>
                    <th class="align-middle">
                        @localizer["Service Acceptance"]
                    </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
    <div class="d-flex justify-content-end mt-3">
        <h5 class="mx-4">
            <span class="bg-black text-white rounded-1 p-1 mx-2">@localizer["Net Patient"] : </span>
            <span class="rounded-1 px-3 py-1" id="netPatient"></span> @localizer["L.E"]
        </h5>
        <h5>
            <span class="bg-black text-white rounded-1 p-1 mx-2">@localizer["Total Service"] : </span>
            <span class="rounded-1 px-3 py-1" id="totalServicesForVisit"></span> @localizer["L.E"]
        </h5>
    </div>
</div>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/jquery/dist/jquery.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/site.js" asp-append-version="true"></script>


@* search *@
<script>
    document.getElementById('searchInput').addEventListener('input', function () {
        filterTable();
    });
    function filterTable() {
        var input = document.getElementById('searchInput');
        var filter = input.value.toUpperCase();
        var table = document.getElementById('myTable');
        var rows = table.getElementsByTagName('tr');

        for (var i = 1; i < rows.length; i++) { // Start from 1 to skip the header row
            var cells = rows[i].getElementsByTagName('td');
            var found = false;

            for (var j = 0; j < cells.length; j++) {
                var cell = cells[j];
                if (cell) {
                    var textValue = cell.textContent || cell.innerText;
                    if (textValue.toUpperCase().indexOf(filter) > -1) {
                        found = true;
                        break;
                    }
                }
            }

            if (found) {
                rows[i].style.display = '';
            } else {
                rows[i].style.display = 'none';
            }
        }
    }
</script>


<script>
	@* Ajax for patAdmisson *@
			function GetAdmisson(e, id) {
				var admissions = document.querySelector(".admisson-table tbody");
				let clinicTrans = document.querySelector(".clinicTrans-table tbody");

				// Handle active clic
				let allItemRows = e.target.parentElement.parentElement.querySelectorAll("tr");;

				allItemRows.forEach(row => {
					row.classList.remove("active-row");
				});

				let clickedTarget = e.target.parentElement
				clickedTarget.classList.add("active-row");
				///////////////////////////////////////////////////////////////////

				// Catch header for pat admission name and reset it
				let patAdmissonHead = document.querySelector(".admission-table-head");

				let itemName = clickedTarget.querySelector(".item-name").innerText;

				let patAdmissonHeader = patAdmissonHead.querySelector(".header.pat-admission"); // Display Header for patAdmisson
				patAdmissonHeader.innerHTML = "@localizer["Visits of patient"] : " + itemName;
				// For remove specific head
				let clinicTransHeader = document.querySelector(".header.clinic-trans");
				clinicTransHeader.innerHTML = "@localizer["Clinic Transaction Invoices For Visit No"] :";


				let patAdmissonAddButton = patAdmissonHead.querySelector("a");
				patAdmissonAddButton.setAttribute("href", `/Medical/PatAdmission/Add_PatientAdmission/${id}?redirect=Invoices`);
				// console.log(patAdmissonAddButton);
				// console.log(clickedTarget);
				///////////////////////////////////////////////////////////////////

				// Handle ajax call
				admissions.innerHTML = "";  // Empty the body
				// For closing clinictrans
				clinicTrans.innerHTML = "";  // Empty the body

				$.ajax({
					url: `/Medical/PatAdmission/GetAdmissions/${id}`,
					success: function (result) {
						// console.log(result);
						//sorting
							// <td class="align-middle">${item.regionDesc}</td>
						result.sort((a, b) => b.masterId - a.masterId)
						for (let item of result) {

							//convert to date not time// Format the date as needed (e.g., "YYYY-MM-DD")
							const PatAdDate = new Date(item.patAdDate).toISOString().split('T')[0];
							//////////////////

							const patAdmission = document.createElement("tr");
							patAdmission.innerHTML +=
	`
							<td class="item-id align-middle">${item.masterId}</td>
							<td class="align-middle">${PatAdDate}</td>
							<td class="align-middle">${item.compId}</td>
							<td class="align-middle">${item.compName}</td>
							<td class="align-middle">${item.compNameDtl}</td>
							<td class="align-middle">${item.classificationDesc}</td>
							<td class="align-middle">${item.drDesc}</td>

								<td class="text-center ">


									<a href="/Medical/DepositVisit/Index/${item.masterId}?redirect=Invoices" class="btn btn-sm btn-success mb-1  fs-6" >
	@Html.Raw(GlobalConstants.InsertIcon)
									</a>
									<a href="/Medical/PatAdmission/Edit_PatientAdmission/${item.masterId}?redirect=Invoices" class="btn btn-sm btn-warning mb-1  fs-6" >
	@Html.Raw(GlobalConstants.EditIcon)
									</a>
								<form action="/Medical/PatAdmission/Delete_PatientAdmission" method="post" class="d-inline ms-1">
	@Html.AntiForgeryToken()
									<input type="hidden" name="id" value="${item.masterId}" />
									<input type="hidden" name="redirect" value="Invoices" />
									 <button type="submit" class="btn btn-sm btn-danger mb-1  fs-6" onclick="return confirm('Are you sure you want to delete this item ?');" >@Html.Raw(GlobalConstants.DeleteIcon)</button>
								</form>

							</td>
									`;
						 //for click to call ajax
							patAdmission.style.cursor = "pointer";
							patAdmission.onclick = function (event) {
								GetClinicTrans(event, item.masterId);
							}
							admissions.appendChild(patAdmission);
							//console.log(section);
						}
					}

				});
			}

		/////////////////////////////////////////////////////////////////////////////////////////////////
	@* Ajax for Clinctrans *@
    function GetClinicTrans(e, id) {

        let mainClinicList = [];
        let subClinicList = [];
        let servList = [];
        let doctorList = []




             fetchMainClinics();
             fetchDoctors();

    



         function fetchMainClinics() {
             // Fetch Main Clinics
           $.ajax({
                 url: '/Medical/MainClinic/GetMainClinics' ,
                 type: 'GET',
                 success: function (data) {
                     mainClinicList = data;
                 }
             });
          
        }
        async function fetchSubClinics(clinicId) {
            // Fetch Sub Clinics
            //const response = await fetch(`/Medical/SubClinic/GetSubClinic/${clinicId}`);
            //const subClinicList = await response.json();
          const data = await $.ajax({
                url: '/Medical/SubClinic/GetSubClinic/' + clinicId,
                type: 'GET'
                //success: function (data) {
                //    subClinicList = data;
                //}
          });
            subClinicList = data;
        }

        async function fetchServ(subClinicId) {
            // Fetch Sub Clinics
           const data = await $.ajax({
                url: '/Medical/ClinicTrans/GetServeClinic/' + subClinicId,
                type: 'GET'
           });
            servList = data;

        }
         function fetchDoctors() {
      
             $.ajax({
                 url: '/Medical/Doctor/GetDoctors',
                 type: 'GET',
                 success: function (data) {
                     doctorList = data;
                 }
             });

        }


        function buildMainClinicDd(row) {
            let html = `<select class="form-control text-center clinic-dropdown" data-field="clinicId" data-id="${row.checkId}">`;
                html += `<option value="">@localizer["Choosee"]</option>`;
            for (let item of mainClinicList) {
                html += `<option value="${item.clinicId}">${item.clinicDesc}</option>`;
            }
            html += `</select>`;
            return html;
        }





        function buildSubClinicDd(row) {
            let html = `<select class="form-control text-center sub-clinic-dropdown " data-field="SClinicId" data-id="${row.checkId}" disabled>`;
            html += `</select>`;
            return html;
        }

        function buildServDd(row) {
            let html = `<select class="form-control text-center serv-dropdown " data-field="ServId" data-id="${row.checkId}" disabled>`;
            html += `</select>`;
            return html;
        }



        function buildDoctorDd(row) {
            let html = `<select class="form-control text-center doctor-dropdown" data-field="drSendId" data-id="${row.checkId}">`;
                html += `<option value="">@localizer["Choosee"]</option>`;
            for (let item of doctorList) {
                html += `<option value="${item.drId}">${item.drDesc}</option>`;
            }
            html += `</select>`;
            return html;
        }



        $('.clinicTrans-table tbody').on('change', '.clinic-dropdown', async function () {
            let selectedClinicId = $(this).val();
            let rowId = $(this).data('id');
            let $SubClinicSelect = $(`.sub-clinic-dropdown[data-id="${rowId}"]`);
            if (selectedClinicId) {

               await fetchSubClinics(selectedClinicId);

                if (subClinicList.length>0) {
                    $SubClinicSelect.prop('disabled', false);
                    $SubClinicSelect.empty().append('<option value="">@localizer["Choosee"]</option>');
                    if (selectedClinicId && subClinicList) {
                        subClinicList.forEach(subClinic => {
                            $SubClinicSelect.append(`<option value="${subClinic.sClinicId}">${subClinic.sClinicDesc}</option>`);
                        });
                    }
                }

            } else {
                $SubClinicSelect.prop('disabled', true);

            }

        });


        $('.clinicTrans-table tbody').on('change', '.sub-clinic-dropdown', async function () {
          let selectedSubClinicId = $(this).val();
          let rowId = $(this).data('id');
          let $ServSelect = $(`.serv-dropdown[data-id="${rowId}"]`);
            if (selectedSubClinicId) {

                await fetchServ(selectedSubClinicId);

              if (subClinicList.length>0) {
                  $ServSelect.prop('disabled', false);
                  $ServSelect.empty().append('<option value="">@localizer["Choosee"]</option>');
                  if (selectedSubClinicId && servList) {
                      servList.forEach(Serv => {
                          $ServSelect.append(`<option value="${Serv.servId}">${Serv.servDesc}</option>`);
                      });
                  }
              }

          } else {
                $ServSelect.prop('disabled', true);

          }

    });




        // Handle active class
        let clickedTarget = e.target.closest('tr');
        let allItemRows = clickedTarget.parentElement.querySelectorAll("tr");

        allItemRows.forEach(row => {
            row.classList.remove("active-row");
        });

        clickedTarget.classList.add("active-row");

        // Update header
        let clinicTransHead = document.querySelector(".clinicTrans-table-head");
        let itemId = clickedTarget.querySelector(".item-id").innerText;
        let clinicTransHeader = clinicTransHead.querySelector(".header.clinic-trans");
        clinicTransHeader.innerHTML = "@localizer["Clinic Transaction Invoices For Visit No"] : " + itemId;

        // Initialize DataTable
        if ($.fn.DataTable.isDataTable('.clinicTrans-table')) {
            $('.clinicTrans-table').DataTable().destroy();
        }

        var table = $('.clinicTrans-table').DataTable({
            ajax: {
                url: '/Medical/ClinicTrans/GetClinicTrans/' + id,
                data: function(d) {
                    return { flag: 1 };
                },
                dataSrc: function(json) {
                    if (json.error) {
                        alert('Error loading data: ' + json.error);
                        return [];
                    }

                    // Calculate totals here
                    let totalServicesForVisit = 0;
                    let netPatient = 0;

                    json.forEach(function(item) {
                        totalServicesForVisit += (item.compValue + item.patientValue);
                        netPatient += (item.extraVal + item.extraVal2 + item.patientValue);
                    });

                    // Update total displays
                    document.getElementById("totalServicesForVisit").classList.add("bg-white");
                    document.getElementById("totalServicesForVisit").innerHTML = totalServicesForVisit.toFixed(2);
                    document.getElementById("netPatient").classList.add("bg-white");
                    document.getElementById("netPatient").innerHTML = netPatient.toFixed(2);

                    return json;
                }
            },
            columns: [
                {
                    data: 'exDate',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return moment(data).format('DD-MM-YYYY');
                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '120px';
                    }
                },
                {
                    data: 'itmServFlag',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            // Display service or item based on itmServFlag
                            return (row.itmServFlag == 3) ? row.servDesc : row.subName;
                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '120px';
                    }
                },
                {
                    data: 'clinicId',
                    render: function (data, type, row) {
                        if (type === 'display') {


                            return buildMainClinicDd(row);

                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '150px';
                    }
                },
                {
                    data: 'sClinicId',
                    render: function (data, type, row) {
                        if (type === 'display') {


                            return buildSubClinicDd(row);

                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '150px';
                    }
                },
                {
                    data: 'servId',
                    render: function (data, type, row) {
                        if (type === 'display') {


                            return buildServDd(row);

                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '150px';
                    }
                },
                {
                    data: 'drSendId',
                    render: function (data, type, row) {
                        if (type === 'display') {


                            return buildDoctorDd(row);

                        }
                        return data;
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '150px';
                    }
                },
                {
                    data: 'unitPrice',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="unitPrice" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },
                {
                    data: 'patientValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="patientValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },
                {
                    data: 'extraVal',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="extraVal" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },
                {
                    data: 'extraVal2',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="extraVal2" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },
                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },

                {
                    data: 'compValue',
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return '<input type="number" step="0.01" class="form-control" value="' + data + '" data-field="compValue" data-id="' + row.checkId + '">';
                        }
                        return data;
                    }
                },
                {
                    // Total service price
                    data: null,
                    render: function (data, type, row) {
                        var total = (parseFloat(row.compValue) + parseFloat(row.patientValue)).toFixed(2);
                        return '<span class="total-service">' + total + '</span>';
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return '<button class="btn btn-sm btn-warning btn-edit" data-id="' + row.checkId + '">@Html.Raw(GlobalConstants.EditIcon)</button> ' +
                               '<button class="btn btn-sm btn-danger btn-delete" data-id="' + row.checkId + '">@Html.Raw(GlobalConstants.DeleteIcon)</button>';
                    },
                    createdCell: function (td) {
                        td.style.minWidth = '100px';
                    }
                }
            ],
            paging: true,
            searching: false,
            ordering: true,
            rowId: function(data) {
                return 'row-' + data.checkId;
            },
            dom: 'Bfrtip',
            buttons: [
                'copy', 'excel', 'pdf', 'print'
            ],
            language: {
                search: "@localizer["Search"]:",
                lengthMenu: "@localizer["Show _MENU_ entries"]",
                info: "@localizer["Showing _START_ to _END_ of _TOTAL_ entries"]",
                infoEmpty: "@localizer["Showing 0 to 0 of 0 entries"]",
                infoFiltered: "@localizer["(filtered from _MAX_ total entries)"]",
                paginate: {
                    first: "@localizer["First"]",
                    last: "@localizer["Last"]",
                    next: "@localizer["Next"]",
                    previous: "@localizer["Previous"]"
                }
            }
        });

        // Handle Add New button
        $('#btnAddNew').off('click').on('click', function () {
            //var maxCheckId = 0;
            //var maxCounter = 0;

            // Find the maximum checkId and counter
            //table.rows().every(function() {
            //    var rowData = this.data();
            //    maxCheckId = Math.max(maxCheckId, rowData.checkId || 0);
            //    maxCounter = Math.max(maxCounter, rowData.counter || 0);
            //});

            var newRowData = {
                exDate: new Date(),
                masterId: id, // Set to the admission ID
                itmServFlag: 3,
                subName: "",
                clinicId: "",
                servDesc: "",
                drDesc: "",
                unitPrice: 0,
                patientValue: 0,
                extraVal: 0,
                extraVal2: 0,
                compValue: 0
            };

            table.row.add(newRowData).draw(false);
        });

        // Auto-calculate patientValue when unitPrice changes
        $('.clinicTrans-table').on('change', 'input[data-field="unitPrice"]', function() {
            var row = $(this).closest('tr');
            var unitPrice = parseFloat($(this).val()) || 0;

            // Set patientValue equal to unitPrice by default
            row.find('input[data-field="patientValue"]').val(unitPrice);

            // Update the totals
            updateRowTotal(row);
            updateGrandTotals();
        });

        // Update other values when they change
        $('.clinicTrans-table').on('change', 'input[data-field]', function() {
            updateRowTotal($(this).closest('tr'));
            updateGrandTotals();
        });

        // Helper function to update row total
        function updateRowTotal(row) {
            var patientValue = parseFloat(row.find('input[data-field="patientValue"]').val()) || 0;
            var compValue = parseFloat(row.find('input[data-field="compValue"]').val()) || 0;
            row.find('.total-service').text((patientValue + compValue).toFixed(2));
        }

        // Helper function to update grand totals
        function updateGrandTotals() {
            var totalServicesForVisit = 0;
            var netPatient = 0;

            table.rows().every(function() {
                var row = $(this.node());
                var patientValue = parseFloat(row.find('input[data-field="patientValue"]').val()) || 0;
                var extraVal = parseFloat(row.find('input[data-field="extraVal"]').val()) || 0;
                var extraVal2 = parseFloat(row.find('input[data-field="extraVal2"]').val()) || 0;
                var compValue = parseFloat(row.find('input[data-field="compValue"]').val()) || 0;

                totalServicesForVisit += (patientValue + compValue);
                netPatient += (patientValue + extraVal + extraVal2);
            });

            document.getElementById("totalServicesForVisit").innerHTML = totalServicesForVisit.toFixed(2);
            document.getElementById("netPatient").innerHTML = netPatient.toFixed(2);
        }

        // Save button click handler
        $('#btnSave').off('click').on('click', function() {
            var modifiedData = [];

            table.rows().every(function() {
                var row = $(this.node());
                var checkId = this.data().checkId;

                var rowData = {
                    checkId: checkId,
                    masterId: id,
                    clinicId: row.find('select[data-field="clinicId"]').val(),
                    itmServFlag: this.data().itmServFlag,
                    servDesc: this.data().servDesc,
                    drDesc: row.find('input[data-field="drDesc"]').val(),
                    unitPrice: parseFloat(row.find('input[data-field="unitPrice"]').val()) || 0,
                    patientValue: parseFloat(row.find('input[data-field="patientValue"]').val()) || 0,
                    extraVal: parseFloat(row.find('input[data-field="extraVal"]').val()) || 0,
                    extraVal2: parseFloat(row.find('input[data-field="extraVal2"]').val()) || 0,
                    compValue: parseFloat(row.find('input[data-field="compValue"]').val()) || 0
                };

                modifiedData.push(rowData);
            });

            // Send data to the server
            $.ajax({
                url: '/Medical/ClinicTrans/SaveClinicTrans',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(modifiedData),
                success: function(response) {
                    if (response.success) {
                        alert('@localizer["Data saved successfully"]');
                        table.ajax.reload();
                    } else {
                        alert('@localizer["Error saving data"]: ' + response.message);
                    }
                },
                error: function(xhr) {
                    alert('@localizer["Error saving data"]: ' + xhr.responseText);
                }
            });
        });

        // Delete button click handler
        $('.clinicTrans-table').on('click', '.btn-delete', function() {
            var checkId = $(this).data('id');

            if (confirm('@localizer["Are you sure you want to delete this item?"]')) {
                $.ajax({
                    url: '/Medical/ClinicTrans/Delete_ClinicTrans',
                    type: 'POST',
                    data: {
                        id: checkId,
                        redirect: 'Invoices'
                    },
                    success: function(response) {
                        table.ajax.reload();
                    },
                    error: function(xhr) {
                        alert('@localizer["Error deleting item"]: ' + xhr.responseText);
                    }
                });
            }
        });
    }
</script>



