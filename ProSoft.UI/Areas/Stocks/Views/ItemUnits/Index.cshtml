@using ProSoft.EF.DTOs.Stocks.ItemUnits
@using ProSoft.UI.Global
@model ItemUnitsViewDTO
@{
    ViewData["title"] = "Item Units";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

<div class="container pt-5">
    <h1 class="mb-5 text-center">ربط الوحدات باصناف الانتاج التام</h1>
    <div class="d-flex mx-3 mb-5 gap-2">
        <label class="form-label fs-4 fw-bold">نوع المخزن</label>
        <select class="form-control" asp-for="Flag1" asp-items="Model.Flag1" id="stockType" style="width:200px">
            <option value="">اختر</option>

        </select>
    </div>


    <div class="row mb-5">
        <div class="col-6 border rounded  p-3" style="min-height:200px;max-height:500px;">
            <table id="ItemsTable" class="table table-hover table-bordered">
                <thead>
                    <tr>

                        <th class="text-center">كود الصنف</th>
                        <th class="text-center">اسم الصنف</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>


    <div class="row ">

        <div class="col border rounded  p-3" style="min-height:200px;max-height:500px;">
            <div class="d-flex gap-2 mb-3">
                <a id="insertItemUnitBtn" class="btn btn-success"> @Html.Raw(GlobalConstants.InsertIcon) اضافة</a>
            </div>
            <table id="UnitsTable" class="table table-hover table-bordered">
                <thead>
                    <tr>
                        <th>الوحدة</th>
                        <th>عدد الاجزاء</th>
                        <th>الاكثر استخداما</th>
                        <th>الاجراءات</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

    </div>
</div>

@section Scripts {
    <script>

        $(document).ready(function () {

            // --------------------- Declerations --------------------- //
            const stockTypeSelect = $('#stockType');
            const subItemsSelect = $('#ItemSelect');
            const insertItemUnitBtn = $('#insertItemUnitBtn');

            var stockType;
            var itemCode;

            // --------------------- Initialization --------------------- //
            stockTypeSelect.select2({ multiple: false });
            subItemsSelect.select2({ multiple: false });

            // --------------------- Select Change Event --------------------- //
            stockTypeSelect.on('select2:select', function (event) {
                stockType = event.params.data.id;

                $('#ItemsTable').DataTable({
                    destroy: true,
                    scrollY: 200,
                    deferRender: true,
                    scroller: true,
                    paging: false,
                    searching: false,
                    columns: [
                        { data: 'id' },
                        { data: 'text' },

                    ],

                    "ajax": {
                        "url": `/Stocks/ItemUnits/GetSubItemsByStockType/${stockType}`,
                        "type": "GET"
                    },

                });
            });

            // --------------------- Select Row Event --------------------- //
            $('#ItemsTable tbody').on('click', 'tr', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                }
                else {
                    $('#ItemsTable tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                    itemCode = $(this).find('td:first').text();

                    $('#UnitsTable').DataTable({
                        destroy: true,
                        scrollY: 200,
                        deferRender: true,
                        scroller: true,
                        paging: false,
                        searching: false,
                        columns: [
                            { data: 'UnitCodee.Names' },
                            { data: 'ItemQty' },
                            {
                                data: "DefaultUnit",  // Assuming each row has a unique ID
                                render: function (data, type, row) {
                                    var checked = data ? 'نعم' : 'لا';
                                    return `<span>${checked}</span>`;
                                },
                                orderable: false,  // Disable sorting on this column
                                searchable: false  // Disable searching on this column

                            },
                            { data: 'DefaultUnit' },

                        ],

                        "ajax": {
                            "url": `/Stocks/ItemUnits/GetItemsUnitByItemCodeAndStockType/?stockType=${stockType}&itemCode=${itemCode}`,
                            "type": "GET"
                        },

                    });

                }

            });

            // --------------------- Insert Item Unit Button Event --------------------- //
            insertItemUnitBtn.on('click', function () {
                window.location.href = `/Stocks/ItemUnits/Add?stockType=${stockType}&itemCode=${itemCode}`;
            })




        });

    </script>
}
