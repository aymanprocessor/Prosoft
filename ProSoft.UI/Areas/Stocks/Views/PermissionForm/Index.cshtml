@model TransMasterViewDTO
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Permissions Forms";
    Layout = "_Layout";
    var isRTL = CultureInfo.CurrentCulture.Name.StartsWith("ar");

    // SelectList permissions = new(ViewBag.Permissions, "GId", "GDesc");
    SelectList stocks = new(ViewBag.Stocks, "Stkcod", "Stknam");
}
@inject IViewLocalizer localizer

<div class="text-center">
    <h2 class="mb-2">@localizer["Permissions Forms"] </h2>
</div>

<div class="container pt-2" style=" min-height:100vh;">
    <div class="page-head d-flex justify-content-between align-items-center flex-column flex-md-row gap-3 my-2">
        <div class="d-flex align-items-center flex-column flex-md-row w-50">
            <label for="stocks" class="@(isRTL ? "ms-3" : "me-3") mb-1 mb-md-0">@localizer["Stocks"]</label>
            <select id="stocks" asp-items="stocks" class="form-control text-center w-100" onchange="getUserPermissionsForStock(event)">
                <option value="">-- Choose --</option>
            </select>
        </div>
        <div class="d-flex align-items-center flex-column flex-md-row w-50">
            <label for="permissions" class="@(isRTL ? "ms-3" : "me-3") mb-1 mb-md-0">@localizer["Permissions"]</label>
            <select id="permissions" class="form-control text-center w-100" onchange="getPermissionsInStock(event)">
                <option value="">-- Choose --</option>
            </select>
        </div>
        <a onclick="goToAddPermissionForm(event, 'permissions', 'stocks')" class="btn btn-sm btn-primary fs-6" style="width:150px">
            @localizer["Add Permission Form"]
        </a>
    </div>

    <div class="overflow-auto" style="height: 225px;">
        <table id="myTable" class="table table-bordered table-hover" style="width:100%;">
            <thead class="table-dark">
                <tr>
                    <th class="align-middle" style="min-width: 100px;">
                        @localizer["Doc No"]
                    </th>
                    <th class="align-middle" style="min-width: 100px;">
                        @localizer["Permission Date"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["Stock Name"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["The Supplier"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["Voucher No"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["Supplier Invoice No"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["From Permission"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["Shipped to"]
                    </th>
                    <th class="align-middle text-center" style="min-width: 100px;">
                        @localizer["Supplier Invoice Date"]
                    </th>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                @if(Model != null)
                {
                <tr class="align-middle text-center">
                    <td>@Model.DocNo</td>
                    <td>@Model.DocDate</td>
                    <td>@Model.StockName</td>
                    <td>@Model.SupplierName</td>
                    <td>@Model.AccTransNo</td>
                    <td>@Model.SupInvNo</td>
                    <td>@Model.DocNoFr</td>
                    <td>@Model.StockCode2</td>
                    <td>@Model.SupInvDate</td>
                    <td style="width: 325px;">
                        <a href="/Stocks/PermissionForm/Edit_PermissionForm/@Model.TransMAsterID" class="btn btn-sm btn-success mb-1 fs-6" style="width: 150px">@localizer["Edit"]</a>
                        <form action="/Stocks/PermissionForm/Delete_PermissionForm" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@Model.TransMAsterID" />
                            <button type="button" onclick="openModalListener(event)" class="btn btn-sm btn-danger mb-1  fs-6" data-modal-target style="width: 150px">@localizer["Delete"]</button>
                            <div class="modal-container">
                                <div class="modal 4" id="modal">
                                    <div class="modal-header fs-4">
                                        <div class="title">@localizer["Confirm Delete"]</div>
                                        <button type="button" onclick="closeModelListener(event)" data-close-button class="close-button">&times;</button>
                                    </div>
                                    <div class="modal-body fs-4">
                                        @localizer["Are you sure you want to delete this item ?"]
                                    </div>
                                    <div class="modal-footer fs-4">
                                        <button type="button" onclick="closeModelListener(event)" data-close-button class="btn btn-secondary">@localizer["No"]</button>
                                        <button class="btn btn-danger">@localizer["Yes"]</button>
                                    </div>
                                </div>
                                <div onclick="overlayListener(event)" id="overlay"></div>
                            </div>
                        </form>
                    </td>
                </tr>
                }
            </tbody>
        </table>
    </div>

    @* /////////////////////////////////////////////////////////////////// *@

    @* Table for UserStock Transactions *@

@*     <div class="transactions-table-head d-flex justify-content-between align-items-center mt-3 mb-1">
        <h2 class="header">@localizer["Transactions of Stocks for User"] :</h2>
        <a class="btn btn-sm btn-primary fs-6" style="width:150px">
            @localizer["Add Permission Form"]
        </a>
    </div>

    <div class="p-0 mb-2 border-opacity-75 overflow-auto" style="max-height: 300px;">

        <table id="myTable_2" class="table table-bordered table-hover" style="width:100%">
            <thead class="table-dark">
                <tr class="align-middle">
                    <th>
                        @localizer["Serial"]
                    </th>
                    <th>
                        @localizer["Permission Type"]
                    </th>
                    <th>
                        @localizer["Stock"]
                    </th>
                    <th class="text-center">
                        @localizer["Stock Is Default"]
                    </th>
                    <th class="text-center">
                        @localizer["Show Trans Price"]
                    </th>
                    <th>
                        @localizer["Debit Account"]
                    </th>
                    <th>
                        @localizer["Credit Account"]
                    </th>
                    <th>
                        @localizer["Journal Type"]
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div> *@
</div>

@section Scripts {
    <script>
        function goToAddPermissionForm(e, permissionID, stockID) {
            let linkButton = e.target;
            let permission = document.getElementById(permissionID);
            let stock = document.getElementById(stockID);

            if (!stock.value) {
                stock.focus();
                return;
            }
            if (!permission.value) {
                permission.focus();
                return;
            }

            if(permission.value == 1)
                linkButton.setAttribute("href", `/Stocks/PermissionForm/Add_PermissionForm/${stock.value}?transType=${permission.value}`);
            else if (permission.value == 2)
                linkButton.setAttribute("href", `/Stocks/PermissionForm/Add_DisburseForm/${stock.value}?transType=${permission.value}`);
        }

        function getUserPermissionsForStock(e) {
            let stock = e.target;
            let permissions = document.getElementById("permissions");
            permissions.innerHTML = `<option value="">-- Choose --</option>`;

            $.ajax({
                url: `/Stocks/PermissionForm/GetUserPermissionsForStock/${stock.value}`,
                success: function (result) {
                    for (let item of result) {
                        permissions.innerHTML +=
                            `<option value="${item.gId}">${item.gDesc}</option>`;
                    }
                }
            });
        }

        function getPermissionsInStock(e) {
            let permission = e.target;
            let stock = document.getElementById("stocks");
            if (!stock.value) {
                stock.focus();
                return;
            }

            let userPermissions = document.querySelector("#myTable tbody");
            userPermissions.innerHTML = "";  // Empty the table

            $.ajax({
                url: `/Stocks/PermissionForm/GetPermissionsForms/${stock.value}?transType=${permission.value}`,
                success: function (result) {
                    for (let item of result) {
                        let docDate = new Date(item.docDate).toISOString().split('T')[0];
                        let supInvDate = new Date(item.supInvDate).toISOString().split('T')[0];
                            // <td class="align-middle text-center">${item.permissionName}</td>
                        const userPerm = document.createElement("tr");
                        userPerm.innerHTML =
                            `
                            <td class="align-middle text-center">${item.docNo}</td>
                            <td class="align-middle text-center">${docDate}</td>
                            <td class="align-middle text-center">${item.stockName}</td>
                            <td class="align-middle text-center">${item.supplierName}</td>
                            <td class="align-middle text-center">${item.accTransNo}</td>
                            <td class="align-middle text-center">${item.supInvNo}</td>
                            <td class="align-middle text-center">${item.docNoFr}</td>
                            <td class="align-middle text-center">${item.stockCode2}</td>
                            <td class="align-middle text-center">${supInvDate}</td>
                            <td class="text-center align-middle" style="width: 325px;">
                                <a href="/Stocks/PermissionForm/Edit_PermissionForm/${item.transMAsterID}" class="btn btn-sm btn-success mb-1 fs-6" style="width: 150px">@localizer["Edit"]</a>
                                <form action="/Stocks/PermissionForm/Delete_PermissionForm" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                    <input type="hidden" name="id" value="${item.transMAsterID}" />
                                    <button type="button" onclick="openModalListener(event)" class="btn btn-sm btn-danger mb-1  fs-6" data-modal-target style="width: 150px">@localizer["Delete"]</button>
                                    <div class="modal-container">
                                        <div class="modal 4" id="modal">
                                            <div class="modal-header fs-4">
                                                <div class="title">@localizer["Confirm Delete"]</div>
                                                <button type="button" onclick="closeModelListener(event)" data-close-button class="close-button">&times;</button>
                                            </div>
                                            <div class="modal-body fs-4">
                                                @localizer["Are you sure you want to delete this item ?"]
                                            </div>
                                            <div class="modal-footer fs-4">
                                                <button type="button" onclick="closeModelListener(event)" data-close-button class="btn btn-secondary">@localizer["No"]</button>
                                                <button class="btn btn-danger">@localizer["Yes"]</button>
                                            </div>
                                        </div>
                                        <div onclick="overlayListener(event)" id="overlay"></div>
                                    </div>
                                </form>
                            </td>
                            `;
                        userPermissions.appendChild(userPerm);
                    }
                }
            });
        }
    </script>
}
